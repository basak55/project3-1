<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div>
    <div class="container" >
        <h2>ì¢…í•©ë­í‚¹</h2>
        <h3 th:text="${info.name}+'ë‹˜ì˜ ë°©ëª…ë¡'"></h3>
        <table class="guestbookInfo">
            <colgroup>
                <col width="50%"/>
                <col width="50%"/>
            </colgroup>
            <tbody th:each="list:${info}">
            <tr>
                <th scope="col">ìˆœìœ„</th>
                <td scope="col">[[${list.ranking}]]</td>
            </tr>
            <tr>
                <th>ë‹‰ë„¤ì„</th>
                <td>[[${list.name}]]</td>
            </tr>
            <tr>
                <th>ë ˆë²¨</th>
                <td>[[${list.grade}]]</td>
            </tr>
            <tr>
                <th>ê²½í—˜ì¹˜</th>
                <td>[[${list.exp}]]</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div style="border-top: 1px solid black; margin-top: 10px; margin-bottom: 10px;"></div>
    <button type="button" class="btns" onclick="like(${info.mno});">ì¶” ì²œ</button>
    <button type="button" class="btns" onclick="">ë¹„ì¶”ì²œ</button>
    <button type="button" class="btns" onclick="">ë’¤ë¡œê°€ê¸°</button>
    <div style="border-top: 1px solid black; margin-top: 10px; margin-bottom: 10px;"></div>

    <div class="cm_list">

    </div>

    <div class="cm_write">
        <fieldset>
            <legend class="skipinfo">ëŒ“ê¸€ ì…ë ¥</legend>
            <div class="cm_input">
                <p><textarea id="content" name="content" onkeyup="countingLength(this);" cols="90" rows="4" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."></textarea></p>
                <span><button type="button" class="btns" onclick="saveComment();">ë“± ë¡</button> <i id="counter">0/300ì</i></span>
            </div>
        </fieldset>
    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript">


    // ëŒ“ê¸€ ê¸¸ì´ ì¹´ìš´íŒ…
    function countingLength(content) {
        if (content.value.length > 300) {
            alert('ëŒ“ê¸€ì„ 300ì ì´í•˜ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            content.value = content.value.substring(0, 300); //300ì ë§Œí¼ì˜ ë¬¸ìì—´ ì¶”ì¶œ
            content.focus(); //ëŒ“ê¸€ì°½ ìë™ í¬ì»¤ìŠ¤
        }
        document.getElementById('counter').innerText = content.value.length + '/300ì';
    }

    // ëŒ“ê¸€ ì €ì¥
    function saveComment() {
        const content = document.getElementById('content');
        // isValid(content, 'ëŒ“ê¸€');

        const guestbookmno = [[${info.mno}]];
        const params = {
            guestbookmno : guestbookmno,
            content : content.value,
            writer : 'í™ê¸¸ë™',
        }
        console.log(params);
        $.ajax({
            url : `/posts/${guestbookmno}/comments`,
            type : 'post',
            contentType : 'application/json; charset=utf-8',
            dataType : 'json',
            data : JSON.stringify(params),
            async : false,
            success : function (response) {
                console.log('ì•„ë¬´ê±°ë‚˜ ë‚˜ì™€ë´');
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ â¸œ( Ë™ Ë˜ Ë™)â¸â™¡');
                content.value = '';
                document.getElementById('counter').innerText = '0/300ì';
                findAllComment();
            },
            error : function (request, status, error) {
                console.log(error)
            }
        });
    }

    //ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = () => {
        findAllComment();
    }
    function findAllComment(){
        const mno = [[${info.mno}]];
        $.ajax({
            url: `/posts/${mno}/comments`,
            type: 'get',
            dataType: 'json',
            async: false,
            success: function (response){
                // console.log(response);
                if(!response.length){ //ê²°ê³¼ì˜ ê¸¸ì´ê°€ 0ì¸ê²½ìš° (ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°)
                    document.querySelector('.cm_list').innerHTML =
                        '<div class="cm_none"><p>ë“±ë¡ëœ ë°©ëª…ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return false; //í•¨ìˆ˜ ì¢…ë£Œ
                }
                let commentHtml = '';
                response.forEach(row =>{
                    commentHtml += `
                        <div>
                            <span class="writer_img"><img src="/images/default_profile.png" width="30" height="30" alt="ê¸°ë³¸ í”„ë¡œí•„ ì´ë¯¸ì§€"/></span>
                            <p class="writer">
                                <em>${row.writer}</em>
                                <span class="date">${row.createdDate}</span>
                            </p>
                            <div class="cont">
                                <div class="txt_${row.cno}">${row.content}</div>
                                <textarea class="txt_${row.cno}_textarea" style="display: none;"  onKeyUp="countingLength(this);" cols="90" rows="4"></textarea>
                            </div>
                            <p class="func_btns">
                                <button type="button" class="commUpdateBtn_${row.cno}" onclick="updateCommentForm(${row.cno})"><span class="icons icon_modify">ìˆ˜ì •</span></button>
                                <button type="button" class="updateCom_${row.cno}" style="display: none;" onclick="updateComment(${row.cno})"><span class="icons icon_modify">ì™„ë£Œ</span></button>
                                <button type="button" class="delBtn_${row.cno}" onclick="deleteComment(${row.cno});"><span class="icons icon_del">ì‚­ì œ</span></button>
                            </p>
                        </div>
                    `;
                })
                document.querySelector('.cm_list').innerHTML = commentHtml;
            },
            error: function (request, status, error){
                console.log(error)
            }
        })
    }

    //ëŒ“ê¸€ ìˆ˜ì •í•˜ê¸°
    function updateCommentForm(cno) {
        console.log(cno);
        const content = document.querySelector(`.txt_${cno}`).innerText;
        document.querySelector(`.txt_${cno}_textarea`).value = content;

        document.querySelector(`.txt_${cno}_textarea`).style.display = 'block';
        document.querySelector(`.updateCom_${cno}`).style.display = 'block';

        document.querySelector(`.commUpdateBtn_${cno}`).style.display = 'none';
        document.querySelector(`.delBtn_${cno}`).style.display = 'none';
        document.querySelector(`.txt_${cno}`).style.display = 'none';
    }

    function updateComment(cno){
        const content = document.querySelector(`.txt_${cno}_textarea`).value;
        const mno = [[${info.mno}]];
        console.log(content, mno);
        const params = {
            cno: cno,
            mno: mno,
            content: content,
            writer: 'í™ê¸¸ë™'
        }
        console.log(params);
        $.ajax({
            url : `/posts/${mno}/comments/${cno}`,
            type : 'patch',
            contentType : 'application/json; charset=utf-8',
            dataType : 'json',
            data : JSON.stringify(params),
            async : false,
            success : function (response) {
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤ ê™³ê’°â€¢â—¡Ìâ€¢ê’±ê™³');
                findAllComment();

            },
            error: function (request, status, error) {
                console.log(error)
            }
        });
    }

    //ëŒ“ê¸€ ì‚­ì œ
    function deleteComment(cno){
        if (!confirm('ì„ íƒí•˜ì‹  ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?â‰ğ“‚‚(â—•Ë“Ë³â—• )ğ“‚‚â‰')) {
            return false; //ì·¨ì†Œí•˜ëŠ” ê²½ìš° ë¡œì§ ì¢…ë£Œ
        }
        const mno=[[${info.mno}]];
        $.ajax({
            url: `/posts/${mno}/comments/${cno}`,
            type : 'delete',
            dataType : 'json',
            async : false,
            success: function (response){
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ (*á´—ÍˆË¬á´—Íˆ)ê•¤*.ï¾Ÿ');
                findAllComment();
            },
            error : function (request, status, error) {
                console.log(error)
            }
        });
    }

    function like(guestbookmno){

    }


</script>

</body>
</html>